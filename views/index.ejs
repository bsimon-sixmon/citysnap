<html>
	<head>
		<meta charset="UTF-8">
		<title>Super Awesome</title>
		<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc= sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
		<link href="/slider/nouislider.min.css" rel="stylesheet">
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
		<style>
			body{
				font-family: 'Oswald', sans-serif;
			}
			.search-address-input{ width:400px !important;}
			.slider-container{margin: 40px 0 60px;}
			.main-container{margin: 0 0 20px;}
			.grid-item { width: 200px; }
			.grid-item--width2 { width: 400px; }
			.item-photo{max-width: 200px; padding:0 10px 10px; }
			.photo-zoom-container{display: none;}
			.photo-zoom-toolbar{margin:0 0 10px;}
			.start-date{
				float: right;
				margin-right: 40px;
			}
			.start-date,.end-date{
				font-weight: bold;
			}
			.likes{
				/*padding: 0px 10px 5px 0;*/
			}
			.like-action{
				padding: 0px 10px 5px 0;
				cursor: pointer;
			}
			.nb-likes{
				font-size: 22px;
			}
			#map { height: 80%; }
			.comments{

			}
			.comment-item .author{
				font-size: 16px;
			}
			.comment-item p{
				font-size: 14px;
			}
		</style>

		<!-- JS Templates -->
		<script id="photo-tmpl" type="x-tmpl-mustache">
			<div class="grid-item">
				<img src="{{ photoUrl }}" data-id="{{ id }}" class="item-photo"/>
			</div>
		</script>

		<script id="photo-zoom-tmpl" type="x-tmpl-mustache">
			<div>
				<div class="photo-zoom-toolbar">
					<a href="javascript:;" class="btn btn-primary back-to-list">retour à la liste</a>
				</div>
				<div>
					<h2>{{ name }}</h2>
					<div class="likes">
						<i class="fa fa-heart like-action fa-2x" data-id="{{id}}"></i><span class="nb-likes">{{nblikes}}</span>
					</div>
					<p>
						<span>Date estimée : entre <strong>{{start_year}}</strong> et <strong>{{end_year}}</strong></span>
					</p>
				</div>
				<div>
					<img src="{{ url }}" class="photo-zoom"/>
				</div>				
			</div>
		</script>

		<script id="comment-tmpl" type="x-tmpl-mustache">
			
			<div class="comment-item">
				<strong class="author">{{FirstName}} {{LastName}}, le {{horodate}}</strong>
				<p>{{comment}}</p>
			</div>
		</script>

	</head>
	<body onLoad="LoadMap()">
		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="/">LA TIME MACHINE</a>
				</div>
				<form class="navbar-form navbar-left" role="search">
					<div class="form-group">
						<input type="text" class="form-control search-address-input" placeholder="Rechercher une adresse">
					</div>
					<a href="javascript:;" class="btn btn-default search-address">Go</a>
				</form>

				 <ul class="nav navbar-nav navbar-right">
				 	<% if(locals.user) { %>
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Bonjour <%= locals.user.FirstName %> <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="/logout">Déconnexion</a></li>
						</ul>
					</li>
					<% } else { %>
					<form class="navbar-form navbar-left" role="search">
						<a href="/login" class="btn btn-default">Se connecter</a>
					</form>
					<% } %>
				</ul>
				<% if(locals.user) { %>
					<form class="navbar-form navbar-right" role="search">
						<a href="/upload" class="btn btn-default">Ajouter une photo</a>
					</form>
				<% } %>
		  </div><!-- /.container-fluid -->
		</nav>



		<div class="row slider-container">
			<div class="col-md-3">
				<span class="start-date">1880</span>
			</div>
			<div class="col-md-6">
				<div id="slider"></div>
			</div>
			<div class="col-md-3">
				<span class="end-date">2015</span>
			</div>
		</div>
		<div class="row main-container">
			<div class="col-md-6">
				<div id="map"></div>
			</div>
			<div class="col-md-6">
				<div class="grid">

				</div>
				<div>
					<div class="photo-zoom-container" >
					</div>					
					<div class="comments" style="display:none;">
					<h3>Commentaires</h3>
						<div class="comment-container">
						</div>
						<textarea  name="comment" class="comment" rows="5" cols="100"></textarea>
						<a href="javascript:;" class="comment-action">envoyer</a>
					</div>
				</div>
			</div>
		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.0/mustache.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/3.3.2/masonry.pkgd.min.js"></script>
		<script src="/slider/nouislider.min.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha256-Sk3nkD6mLTMOF0EOpNtsIry+s1CsaqQC1rVLTAy+0yc= sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
		<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
		<script src='/js/jquery.cloudinary.js' type='text/javascript'></script>
		<script type="text/javascript">
			var map, msnry, markers = {}, selectedMarkerId, data = {};
			var west,east,north,south;
			var startDate = 1880, endDate = 2015;
			var photoTemplate = $('#photo-tmpl').html();
			var photoZoomTemplate = $('#photo-zoom-tmpl').html();
			var commentTemplate = $('#comment-tmpl').html();
			Mustache.parse(photoTemplate);
			Mustache.parse(photoZoomTemplate);
			Mustache.parse(commentTemplate);

			$.cloudinary.config({ cloud_name: 'sixmon', api_key: '722328586973638'});


			//------------------------------------------------
			// SLIDER
			var slider = document.getElementById('slider');

			noUiSlider.create(slider, {
				start: [1880, 2015],
				connect: true,
				step: 1,
				range: {
					'min': 1880,
					'max': 2015
				}
			});

			slider.noUiSlider.on('update', function( values, handle ) {

				var value = values[handle];

				if (handle) {
					endDate = Math.round(value);
					$(".end-date").text(endDate);
				}
				else {
					startDate = Math.round(value);
					$(".start-date").text(startDate);
				}
			});

			slider.noUiSlider.on('change', function() {
				SearchPhotos();
			});

			//------------------------------------------------------------
			// MAP
			var cameraIcon = L.icon({
				iconUrl: 'images/camera.png',
				iconSize:     [32, 32], // size of the icon
				iconAnchor:   [16, 16] // point of the icon which will correspond to marker's location
			});

			var selectedCameraIcon = L.icon({
				iconUrl: 'images/camera_selected.png',
				iconSize:     [32, 32], // size of the icon
				iconAnchor:   [16, 16] // point of the icon which will correspond to marker's location
			});

			
			function LoadMap(){

				map = L.map('map');

				var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
				//var osmUrl = 'http://servicesig102.lehavre.fr/arcgis/rest/services/fond_historique/1939/MapServer/tile/{z}/{x}/{y}.png';
				var osmAttrib='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
				var osm = new L.TileLayer(osmUrl, { attribution: osmAttrib});

				/*L.esri.tiledMapLayer({
					//url: 'http://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer',
					url: 'http://servicesig102.lehavre.fr/arcgis/rest/services/fond_historique/1939/MapServer',
					maxZoom: 15
				}).addTo(map);*/

				map.setView(new L.LatLng(49.4942, 0.10713), 13);
				map.addLayer(osm);

				map.on('moveend', function(){
					GetMapBounds();
					SearchPhotos();
				});

				// Init State
				GetMapBounds();
				SearchPhotos();
			}

			var GetMapBounds = function(){
				var bounds = map.getBounds();
				west = bounds.getWest();
				east = bounds.getEast();
				north = bounds.getNorth();
				south = bounds.getSouth();
			}


			//--------------------------------------------------------------------
			// SEARCH
			var SearchPhotos = function(){

				var params = "w=" + west + "&e=" + east + "&s=" + south + "&n=" + north + "&sdate=" + startDate + "&edate=" + endDate;
				$.get("/search?" + params, function(res){

					var content = "";
					for(var i=0; i<res.length;i++){
						var m = new L.marker(new L.latLng(res[i].latitude, res[i].longitude), {icon: cameraIcon}).addTo(map);
						markers[res[i].id] = m;
						data[res[i].id] = res[i];
						res[i].photoUrl =  $.cloudinary.url(res[i].public_id, { width: 200, crop: 'fill' });
						content += Mustache.render(photoTemplate, res[i]);
					}

					$(".grid").empty().append(content);
					var $items = $(content);
					// append items to grid
					//$(".grid").empty().append(content);
					// add and lay out newly appended items
					setTimeout(function(){
						var elem = document.querySelector('.grid');
						msnry = new Masonry( elem, {
							// options
							itemSelector: '.grid-item',
							columnWidth: 200
						});
					}, 100);

					$(".main-container .photo-zoom-container").hide();
					$(".main-container .grid").show();
					//msnry.reloadItems();
				});
			}

			var Geocode = function(){

				var input = $(".search-address-input").val();

				$.get("http://open.mapquestapi.com/geocoding/v1/address?key=Fmjtd%7Cluur2hu7nu%2C72%3Do5-9waldu&location=" + input, function(res){
					debugger;
				});
			}

			var GetComments = function(photoId){

				$.get("/photo/" + photoId + "/comments", function(res){
						if(res != "ERROR"){
							$(".comment-container").empty();
							for(var i=0;i<res.length;i++){
								$(".comment-container").append(Mustache.render(commentTemplate, res[i]));
							}
						}
					});

			}

			$(document).ready(function(){

				var elem = document.querySelector('.grid');
				msnry = new Masonry( elem, {
					// options
					itemSelector: '.grid-item',
					columnWidth: 200
				});

				$(".main-container").on("click", ".item-photo", function(){

					// Affichage de la grosse photo
					selectedMarkerId = $(this).data("id");
					$(".main-container .photo-zoom-container").empty().append(Mustache.render(photoZoomTemplate, data[selectedMarkerId]));

					markers[selectedMarkerId].setIcon(selectedCameraIcon).setZIndexOffset(1000);

					$(".main-container .grid").hide();
					$(".main-container .photo-zoom-container").show();


					// Affichage des commentaires associés
					GetComments(selectedMarkerId);

					$(".comments").show();
				});

				$(".main-container").on("click", ".back-to-list", function(){
					markers[selectedMarkerId].setIcon(cameraIcon).setZIndexOffset(1);
					$(".main-container .photo-zoom-container").hide();
					$(".main-container .grid").show();
					$(".comments").hide();
				});

				$(".search-address").on("click", function(){
					Geocode();
				});

				$(".photo-zoom-container").on("click",".like-action", function(){

					var photoId = $(this).data("id");
					$.get("/photo/" + photoId + "/like", function(res){
						if(res == "OK"){
							var nblikes = $(".nb-likes").text();
							$(".nb-likes").text(parseInt(nblikes) + 1);
						}
					});
				});

				$(".comments").on("click",".comment-action", function(){
					
					var comment = $(".comment").val();
					$.post("/photo/" + selectedMarkerId + "/comment", { comment : comment } , function(res){
						GetComments(selectedMarkerId);
					});
				});

			});

		</script>

	</body>
</html>
